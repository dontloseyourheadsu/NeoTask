@using NeoTask.WebApp.Components.Customization
@inject ThemeState ThemeState
@inject IJSRuntime JSRuntime
@implements IDisposable
@rendermode InteractiveServer

<div class="theme-switcher px-3 py-2">
    <label for="themeSelect" class="form-label text-light small">Theme</label>
    <select id="themeSelect" class="form-select form-select-sm" @onchange="OnThemeChange"
        value="@ThemeState.CurrentTheme">
        <option value="theme-calm">Calm Focus</option>
        <option value="theme-low-sensory">Low Sensory</option>
        <option value="theme-high-dopamine">High Dopamine</option>
    </select>
</div>

@code {
    protected override void OnInitialized()
    {
        ThemeState.OnChange += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Sync state with the actual theme applied to body (from cookie/SSR)
            var currentTheme = await JSRuntime.InvokeAsync<string>("eval", "document.body.className");
            if (!string.IsNullOrEmpty(currentTheme) && currentTheme != ThemeState.CurrentTheme)
            {
                ThemeState.SetTheme(currentTheme);
                StateHasChanged();
            }
        }
    }

    private async Task OnThemeChange(ChangeEventArgs e)
    {
        var newTheme = e.Value?.ToString() ?? "theme-calm";
        ThemeState.SetTheme(newTheme);
        await JSRuntime.InvokeVoidAsync("setTheme", newTheme);
    }

    public void Dispose()
    {
        ThemeState.OnChange -= StateHasChanged;
    }
}