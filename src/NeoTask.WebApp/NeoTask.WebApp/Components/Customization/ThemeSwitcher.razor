@using NeoTask.WebApp.Components.Customization
@inject ThemeState ThemeState
@inject IJSRuntime JSRuntime
@implements IDisposable
@rendermode InteractiveServer

<div class="theme-switcher px-3 py-2">
    <div class="mb-2">
        <label for="themeSelect" class="form-label text-light small">Theme</label>
        <select id="themeSelect" class="form-select form-select-sm" @onchange="OnThemeChange"
            value="@ThemeState.CurrentTheme">
            <option value="theme-calm">Calm Focus</option>
            <option value="theme-low-sensory">Low Sensory</option>
            <option value="theme-high-dopamine">High Dopamine</option>
        </select>
    </div>
    <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="fontToggle" checked="@ThemeState.IsAccessibleFont"
            @onchange="OnFontToggle">
        <label class="form-check-label text-light small" for="fontToggle">Accessible Font</label>
    </div>
</div>

@code {
    protected override void OnInitialized()
    {
        ThemeState.OnChange += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Sync state with the actual theme applied to body
            var classList = await JSRuntime.InvokeAsync<string>("eval", "document.body.className");
            var classes = classList.Split(' ');

            var currentTheme = classes.FirstOrDefault(c => c.StartsWith("theme-")) ?? "theme-calm";
            var isAccessible = classes.Contains("font-accessible");

            if (currentTheme != ThemeState.CurrentTheme || isAccessible != ThemeState.IsAccessibleFont)
            {
                ThemeState.SetTheme(currentTheme);
                ThemeState.SetAccessibleFont(isAccessible);
                StateHasChanged();
            }
        }
    }

    private async Task OnThemeChange(ChangeEventArgs e)
    {
        var newTheme = e.Value?.ToString() ?? "theme-calm";
        ThemeState.SetTheme(newTheme);
        await JSRuntime.InvokeVoidAsync("setTheme", newTheme);
    }

    private async Task OnFontToggle(ChangeEventArgs e)
    {
        var isAccessible = (bool)(e.Value ?? false);
        ThemeState.SetAccessibleFont(isAccessible);
        await JSRuntime.InvokeVoidAsync("toggleAccessibleFont", isAccessible);
    }

    public void Dispose()
    {
        ThemeState.OnChange -= StateHasChanged;
    }
}