@page "/"
@rendermode InteractiveServer
@using NeoTask.Domain.Tasks.Attributes
@using NeoTask.Domain.Tasks
@using NeoTask.WebApp.Models.Query
@using NeoTask.WebApp.Services
@using NeoTask.WebApp.Services.Tasks.Queries
@inject IScrollInfoService scrollInfoService
@inject ITaskQueryService TaskService
@inject IJSRuntime JSRuntime
@implements IDisposable

<PageTitle>Home</PageTitle>

<div class="home-grid">
    <div class="grid-left"></div>

    <div class="grid-center">
        <div class="date-controls">
            <button class="control-btn small" @onclick="PreviousDay" title="Previous Day">
                <span class="material-icons" aria-hidden="true">chevron_left</span>
            </button>

            <div class="current-date">@CurrentDateText</div>

            <button class="control-btn small" @onclick="NextDay" title="Next Day">
                <span class="material-icons" aria-hidden="true">chevron_right</span>
            </button>
        </div>

        <hr class="title-divider" />

        @if (FocusedTask != null)
        {
            <button class="unfocus-btn center" @onclick="Unfocus">Unfocus Task</button>
        }

        @if (FocusedTask == null)
        {
            <div class="task-list-scroll-container">
                @foreach (var task in AllTasks)
                {
                    <div id="@($"task-{task.Id}")" class="task-card" @onclick="() => SelectTask(task)">
                        <span class="dimmed-title">@task.Title</span>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="focus-container">
                <div class="task-list-container" id="taskList">
                    @foreach (var task in VisibleTasks)
                    {
                        if (task != null)
                        {
                            <div id="@($"task-{task.Id}")" class="task-card @GetTaskClass(task)" @onclick="() => SelectTask(task)">
                                @if (task.Id == FocusedTask?.Id)
                                {
                                    <div class="focused-content">
                                        <h1 class="task-title">@task.Title</h1>
                                        <button class="break-down-btn" @onclick:stopPropagation="true">Break Down</button>
                                        <p class="task-desc">@task.Description</p>
                                    </div>
                                }
                                else
                                {
                                    <span class="dimmed-title">@task.Title</span>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="task-card empty-slot"></div>
                        }
                    }
                </div>
            </div>
        }
    </div>

    <div class="grid-right">
        <button class="toggle-btn" @onclick="ToggleDateless">
            <span class="material-icons" aria-hidden="true">event_busy</span>
            <span class="btn-text">@ToggleLabel</span>
        </button>

        @if (FocusedTask != null)
        {
            <div class="side-controls">
                <button class="control-btn up-btn" @onclick="MoveUp" title="Previous Task">
                    <span class="material-icons">arrow_upward</span>
                </button>
                <button class="control-btn down-btn" @onclick="MoveDown" title="Next Task">
                    <span class="material-icons">arrow_downward</span>
                </button>
            </div>
        }
    </div>
</div>

@code {
    private List<NeoTaskCore> AllTasks = new();
    private LinkedList<NeoTaskCore?> VisibleTasks = new();
    private NeoTaskCore? FocusedTask;
    private int _firstVisibleIndex = 0;
    private const int DefaultWindowSize = 20;
    private const int FocusedWindowSize = 3;
    private DateTime _currentDay = DateTime.Today;
    private bool _showDateless = false;

    private string CurrentDateText => _showDateless ? "Dateless Tasks" : _currentDay.ToString("dddd, MMM d, yyyy");
    private string ToggleLabel => _showDateless ? "Show Dated" : "Show Dateless";

    protected override void OnInitialized()
    {
        AllTasks = TaskService.GetTasks().ToList();
        // No need to initialize list view for scrolling mode as we render AllTasks directly
        FocusedTask = null;

        scrollInfoService.OnScroll += OnScroll;
    }

    private void LoadTasksForCurrentView()
    {
        if (_showDateless)
        {
            var req = new QueryRequest(pageNumber: 1, pageSize: 200);
            AllTasks = TaskService.QueryTasks(req).ToList();
            // Filter dateless client-side since request has no date range
            AllTasks = AllTasks.Where(t => !t.GoalDate.HasValue).ToList();
        }
        else
        {
            var start = _currentDay.Date;
            var end = start.AddDays(1).AddTicks(-1);
            var req = new QueryRequest(goalDateFrom: start, goalDateTo: end, pageNumber: 1, pageSize: 200);
            AllTasks = TaskService.QueryTasks(req).ToList();
        }
    }

    private void OnScroll(object? sender, int yValue)
    {
        // Only handle custom scroll when focused
        if (FocusedTask == null) return;

        // yValue from wheel event is deltaY (positive = down, negative = up)
        // Or scroll position if actual scroll.
        // Since we use wheel for navigation in fixed container:
        if (yValue > 0)
        {
            InvokeAsync(MoveDown);
        }
        else if (yValue < 0)
        {
            InvokeAsync(MoveUp);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await scrollInfoService.InitializeAsync();
        }
    }

    public void Dispose()
    {
        scrollInfoService.OnScroll -= OnScroll;
    }

    private string GetTaskClass(NeoTaskCore task)
    {
        if (FocusedTask?.Id == task.Id) return "focused";
        if (FocusedTask != null) return "dimmed";
        return "";
    }

    private void SelectTask(NeoTaskCore task)
    {
        FocusedTask = task;
        UpdateFocusedView();
        StateHasChanged();
    }

    private void UpdateFocusedView()
    {
        if (FocusedTask == null) return;

        VisibleTasks.Clear();
        int index = AllTasks.FindIndex(t => t.Id == FocusedTask.Id);

        // Previous
        if (index > 0) VisibleTasks.AddLast(AllTasks[index - 1]);
        else VisibleTasks.AddLast((NeoTaskCore?)null);

        // Current
        VisibleTasks.AddLast(FocusedTask);

        // Next
        if (index < AllTasks.Count - 1) VisibleTasks.AddLast(AllTasks[index + 1]);
        else VisibleTasks.AddLast((NeoTaskCore?)null);
    }

    private void Unfocus()
    {
        FocusedTask = null;
        StateHasChanged();
    }

    private void MoveUp()
    {
        if (FocusedTask == null) return;
        MoveFocusUp();
        StateHasChanged();
    }

    private void MoveDown()
    {
        if (FocusedTask == null) return;
        MoveFocusDown();
        StateHasChanged();
    }

    private void MoveFocusUp()
    {
        if (FocusedTask == null) return;

        int index = AllTasks.FindIndex(t => t.Id == FocusedTask.Id);
        if (index > 0)
        {
            FocusedTask = AllTasks[index - 1];

            // Update VisibleTasks for sliding window
            VisibleTasks.RemoveLast();

            int newPrevIndex = index - 2;
            if (newPrevIndex >= 0)
                VisibleTasks.AddFirst(AllTasks[newPrevIndex]);
            else
                VisibleTasks.AddFirst((NeoTaskCore?)null);
        }
    }

    private void MoveFocusDown()
    {
        if (FocusedTask == null) return;

        int index = AllTasks.FindIndex(t => t.Id == FocusedTask.Id);
        if (index < AllTasks.Count - 1)
        {
            FocusedTask = AllTasks[index + 1];

            // Update VisibleTasks for sliding window
            VisibleTasks.RemoveFirst();

            int newNextIndex = index + 2;
            if (newNextIndex < AllTasks.Count)
                VisibleTasks.AddLast(AllTasks[newNextIndex]);
            else
                VisibleTasks.AddLast((NeoTaskCore?)null);
        }
    }

    private async Task ScrollToTask(Guid taskId)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", $"document.getElementById('task-{taskId}').scrollIntoView({{ behavior: 'smooth', block: 'center' }})");
        }
        catch
        {
            // Ignore JS errors for now
        }
    }

    private void PreviousDay()
    {
        if (_showDateless) return;
        Unfocus();
        _currentDay = _currentDay.AddDays(-1);
        LoadTasksForCurrentView();
        StateHasChanged();
    }

    private void NextDay()
    {
        if (_showDateless) return;
        Unfocus();
        _currentDay = _currentDay.AddDays(1);
        LoadTasksForCurrentView();
        StateHasChanged();
    }

    private void ToggleDateless()
    {
        _showDateless = !_showDateless;
        Unfocus();
        LoadTasksForCurrentView();
        StateHasChanged();
    }
}