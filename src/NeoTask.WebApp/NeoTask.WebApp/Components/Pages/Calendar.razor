@page "/calendar"
@using NeoTask.Domain.Tasks
@using NeoTask.WebApp.Services
@using NeoTask.WebApp.Services.Tasks.Queries
@using NeoTask.WebApp.Models.Calendar
@inject ITaskQueryService TaskService

<PageTitle>Calendar</PageTitle>

<div class="calendar-container">
    <div class="header">
        <h1>Today's River</h1>
        <p class="date-display">@DateTime.Today.ToString("D")</p>
    </div>

    <div class="timeline-river">
        @foreach (var item in TimelineItems)
        {
            @if (item is TaskTimelineItem taskItem)
            {
                <div class="timeline-task" style="height: @(taskItem.HeightPx)px;">
                    <div class="time-column">
                        <span class="time-label">@taskItem.Task.GoalDate?.ToString("h:mm tt")</span>
                    </div>
                    <div class="task-content">
                        <h3>@taskItem.Task.Title</h3>
                        <p>@taskItem.Task.Description</p>
                    </div>
                </div>
            }
            else if (item is GapTimelineItem gapItem)
            {
                <div class="timeline-gap @(gapItem.IsSafeTime ? "safe-time" : "")" style="height: @(gapItem.HeightPx)px;">
                    @if (gapItem.IsSafeTime)
                    {
                        <div class="safe-time-content">
                            <span class="ai-label">AI Insight</span>
                            <span class="safe-message">@gapItem.Label</span>
                        </div>
                    }
                </div>
            }
        }
    </div>
</div>

@code {
    private List<TimelineItem> TimelineItems = new();
    private const double PixelsPerHour = 120.0; // 1 hour = 120px

    protected override void OnInitialized()
    {
        var tasks = TaskService.GetTasks()
        .Where(t => t.GoalDate.HasValue && t.GoalDate.Value.Date == DateTime.Today)
        .OrderBy(t => t.GoalDate)
        .ToList();

        if (!tasks.Any())
        {
            // If no tasks today, maybe show a message or empty state
            return;
        }

        // Start of the day logic
        // We start rendering from the first task or 8 AM, whichever is earlier
        var startOfDay = DateTime.Today.AddHours(8);
        DateTime currentTime = tasks.First().GoalDate!.Value < startOfDay ? tasks.First().GoalDate!.Value : startOfDay;

        foreach (var task in tasks)
        {
            // Calculate gap before task
            if (task.GoalDate > currentTime)
            {
                var gap = task.GoalDate.Value - currentTime;
                // Only show gaps that are significant enough to be visible (e.g. > 5 mins)
                if (gap.TotalMinutes > 5)
                {
                    var isSafe = gap.TotalMinutes >= 60; // 1 hour+ is "Safe Time"
                    TimelineItems.Add(new GapTimelineItem
                    {
                        Duration = gap,
                        HeightPx = gap.TotalHours * PixelsPerHour,
                        IsSafeTime = isSafe,
                        Label = isSafe ? $"You have {GetFriendlyDuration(gap)} of safe focus time here." : ""
                    });
                }
            }

            // Add task
            var duration = task.EstimatedDuration ?? TimeSpan.FromMinutes(30);
            TimelineItems.Add(new TaskTimelineItem
            {
                Task = task,
                HeightPx = duration.TotalHours * PixelsPerHour
            });

            currentTime = task.GoalDate.Value.Add(duration);
        }

        // Add a buffer at the end
        TimelineItems.Add(new GapTimelineItem
        {
            Duration = TimeSpan.FromHours(1),
            HeightPx = PixelsPerHour,
            IsSafeTime = false
        });
    }

    private string GetFriendlyDuration(TimeSpan ts)
    {
        if (ts.TotalHours >= 1)
        {
            return $"{ts.TotalHours:0.#} hours";
        }
        return $"{ts.TotalMinutes} minutes";
    }
}